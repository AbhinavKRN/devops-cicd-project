# =============================================================================
# CI Pipeline for TaskManager API
# Production-grade Continuous Integration with Security & Quality Gates
# =============================================================================
# 
# WHY THIS PIPELINE EXISTS:
# This CI pipeline implements shift-left security and DevSecOps principles,
# catching issues early in the development cycle where they are cheaper to fix.
#
# PIPELINE PHILOSOPHY:
# - Fail fast: Quick checks run first to provide rapid feedback
# - Security-first: Multiple security scans at different layers
# - Quality gates: Code must pass all checks before deployment
# - Traceability: Every artifact is tagged and traceable
# =============================================================================

name: CI Pipeline

on:
  push:
    branches: 
      - master
      - main
      - develop
  pull_request:
    branches: 
      - master
      - main
  workflow_dispatch:  # Manual trigger for on-demand builds

permissions:
  contents: read
  security-events: write  # Required for uploading SARIF results to Security tab

env:
  JAVA_VERSION: '17'
  DOCKER_IMAGE_NAME: taskmanager-api
  REGISTRY: docker.io

jobs:
  # ===========================================================================
  # STAGE 1: CHECKOUT & SETUP
  # ===========================================================================
  # WHY: Foundation stage that retrieves source code and prepares build environment
  # RISK MITIGATED: Ensures consistent, clean source for all subsequent stages
  # ===========================================================================
  
  build-and-test:
    name: Build, Lint & Test
    runs-on: ubuntu-latest
    
    steps:
      # -----------------------------------------------------------------------
      # CHECKOUT: Retrieve source code from repository
      # -----------------------------------------------------------------------
      # WHY: All pipeline stages need access to the source code
      # This ensures we're building from the exact commit that triggered the pipeline
      # -----------------------------------------------------------------------
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      # -----------------------------------------------------------------------
      # SETUP JAVA RUNTIME
      # -----------------------------------------------------------------------
      # WHY: Consistent Java version across all environments
      # RISK MITIGATED: "Works on my machine" issues due to version differences
      # -----------------------------------------------------------------------
      - name: Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven  # Cache dependencies for faster builds

      # -----------------------------------------------------------------------
      # DEPENDENCY CACHE
      # -----------------------------------------------------------------------
      # WHY: Speeds up builds by caching Maven dependencies
      # BENEFIT: Reduces build time from ~3 min to ~1 min on cache hit
      # -----------------------------------------------------------------------
      - name: Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # -----------------------------------------------------------------------
      # LINTING: Code Quality Checks
      # -----------------------------------------------------------------------
      # WHY: Enforces coding standards and catches style issues early
      # RISK MITIGATED: Technical debt, inconsistent code style, maintainability issues
      # SHIFT-LEFT: Catches formatting issues before code review
      # -----------------------------------------------------------------------
      - name: Run Checkstyle Linting
        run: mvn checkstyle:check -B
        continue-on-error: true  # Don't fail build, but report issues

      # -----------------------------------------------------------------------
      # UNIT TESTS
      # -----------------------------------------------------------------------
      # WHY: Validates business logic and prevents regressions
      # RISK MITIGATED: Broken functionality reaching production
      # COVERAGE: JaCoCo generates coverage reports for quality metrics
      # -----------------------------------------------------------------------
      - name: Run Unit Tests with Coverage
        run: mvn test jacoco:report -B

      # -----------------------------------------------------------------------
      # BUILD APPLICATION
      # -----------------------------------------------------------------------
      # WHY: Compiles and packages the application into deployable artifact
      # OUTPUT: JAR file ready for containerization
      # -----------------------------------------------------------------------
      - name: Build Application
        run: mvn clean package -DskipTests -B

      # -----------------------------------------------------------------------
      # UPLOAD BUILD ARTIFACTS
      # -----------------------------------------------------------------------
      # WHY: Preserves build outputs for subsequent jobs and debugging
      # -----------------------------------------------------------------------
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: target/*.jar
          retention-days: 7

      - name: Upload Test Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            target/surefire-reports/
            target/site/jacoco/
          retention-days: 7

  # ===========================================================================
  # STAGE 2: STATIC APPLICATION SECURITY TESTING (SAST)
  # ===========================================================================
  # WHY: Analyzes source code for security vulnerabilities without execution
  # RISK MITIGATED: OWASP Top 10 vulnerabilities, code-level security flaws
  # TOOL: CodeQL - GitHub's semantic code analysis engine
  # ===========================================================================
  
  sast-codeql:
    name: SAST - CodeQL Analysis
    runs-on: ubuntu-latest
    needs: build-and-test
    permissions:
      contents: read
      security-events: write  # Required for uploading to Security tab

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # CODEQL INITIALIZATION
      # -----------------------------------------------------------------------
      # WHY: Prepares CodeQL database for Java analysis
      # DETECTS: SQL Injection, XSS, Path Traversal, Command Injection, etc.
      # -----------------------------------------------------------------------
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: java
          # Custom queries for enhanced security scanning
          queries: security-extended,security-and-quality

      - name: Setup Java for CodeQL
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      # -----------------------------------------------------------------------
      # AUTOBUILD: CodeQL builds the project to analyze bytecode
      # -----------------------------------------------------------------------
      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      # -----------------------------------------------------------------------
      # CODEQL ANALYSIS
      # -----------------------------------------------------------------------
      # WHY: Performs deep semantic analysis of the codebase
      # OUTPUT: SARIF results uploaded to GitHub Security tab
      # -----------------------------------------------------------------------
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:java"

  # ===========================================================================
  # STAGE 3: SOFTWARE COMPOSITION ANALYSIS (SCA)
  # ===========================================================================
  # WHY: Scans third-party dependencies for known vulnerabilities
  # RISK MITIGATED: Supply chain attacks, vulnerable libraries (Log4Shell, etc.)
  # TOOL: OWASP Dependency-Check
  # ===========================================================================
  
  sca-dependency-check:
    name: SCA - Dependency Security Scan
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      # -----------------------------------------------------------------------
      # OWASP DEPENDENCY CHECK
      # -----------------------------------------------------------------------
      # WHY: Identifies vulnerable dependencies before deployment
      # DETECTS: Known CVEs in all direct and transitive dependencies
      # THRESHOLD: Fails build on CVSS score >= 7 (High/Critical)
      # -----------------------------------------------------------------------
      - name: Run OWASP Dependency Check
        run: mvn org.owasp:dependency-check-maven:check -B
        continue-on-error: true  # Report but don't block for demo

      # -----------------------------------------------------------------------
      # UPLOAD DEPENDENCY CHECK REPORTS
      # -----------------------------------------------------------------------
      - name: Upload Dependency Check Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-report
          path: target/dependency-check-report.*
          retention-days: 30

  # ===========================================================================
  # STAGE 4: DOCKER BUILD & CONTAINER SECURITY
  # ===========================================================================
  # WHY: Creates production container and scans for OS/library vulnerabilities
  # RISK MITIGATED: Vulnerable base images, misconfigured containers
  # TOOLS: Docker, Trivy
  # ===========================================================================
  
  docker-build-scan:
    name: Docker Build & Security Scan
    runs-on: ubuntu-latest
    needs: [build-and-test, sast-codeql]
    permissions:
      contents: read
      security-events: write  # Needed for github/codeql-action/upload-sarif
    
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Build Application JAR
        run: mvn clean package -DskipTests -B

      # -----------------------------------------------------------------------
      # DOCKER BUILDX SETUP
      # -----------------------------------------------------------------------
      # WHY: Enables advanced Docker build features (caching, multi-platform)
      # -----------------------------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -----------------------------------------------------------------------
      # BUILD DOCKER IMAGE
      # -----------------------------------------------------------------------
      # WHY: Creates container image for deployment
      # BEST PRACTICES: Multi-stage build, non-root user, minimal base image
      # -----------------------------------------------------------------------
      - name: Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: |
            ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
            ${{ env.DOCKER_IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # -----------------------------------------------------------------------
      # TRIVY CONTAINER SCAN
      # -----------------------------------------------------------------------
      # WHY: Scans container image for OS and library vulnerabilities
      # DETECTS: CVEs in base image, installed packages, and application dependencies
      # THRESHOLD: Reports HIGH and CRITICAL vulnerabilities
      # -----------------------------------------------------------------------
      - name: Run Trivy Container Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Don't fail build, but report issues

      # -----------------------------------------------------------------------
      # UPLOAD TRIVY RESULTS TO SECURITY TAB
      # -----------------------------------------------------------------------
      - name: Upload Trivy Results to GitHub Security Tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      # -----------------------------------------------------------------------
      # TRIVY TABLE OUTPUT (For Logs)
      # -----------------------------------------------------------------------
      - name: Display Trivy Scan Results
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}'
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'

      # -----------------------------------------------------------------------
      # CONTAINER RUNTIME TEST (Smoke Test)
      # -----------------------------------------------------------------------
      # WHY: Validates container starts and responds to health checks
      # RISK MITIGATED: Broken containers reaching deployment
      # -----------------------------------------------------------------------
      - name: Container Runtime Test
        run: |
          echo "Starting container for runtime validation..."
          docker run -d --name test-container -p 8080:8080 ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          
          echo "Waiting for application to start..."
          sleep 30
          
          echo "Performing health check..."
          for i in {1..10}; do
            if curl -s http://localhost:8080/api/v1/health | grep -q "UP"; then
              echo "âœ… Health check passed!"
              break
            fi
            echo "Attempt $i: Waiting for application..."
            sleep 5
          done
          
          # Verify API endpoints
          echo "Testing API endpoints..."
          curl -s http://localhost:8080/api/v1/health
          curl -s http://localhost:8080/api/v1/ready
          curl -s http://localhost:8080/api/v1/live
          
          # Cleanup
          docker stop test-container
          docker rm test-container
          echo "âœ… Container runtime test completed successfully!"

      # -----------------------------------------------------------------------
      # SAVE DOCKER IMAGE FOR NEXT STAGE
      # -----------------------------------------------------------------------
      - name: Save Docker Image
        run: docker save ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }} > image.tar

      - name: Upload Docker Image Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: image.tar
          retention-days: 1

  # ===========================================================================
  # STAGE 5: PUSH TO DOCKER HUB
  # ===========================================================================
  # WHY: Publishes verified, scanned image to container registry
  # PREREQUISITE: All security scans and tests must pass
  # SECURITY: Uses GitHub Secrets for credentials (never hardcoded)
  # ===========================================================================
  
  docker-push:
    name: Push to Docker Hub
    runs-on: ubuntu-latest
    needs: [docker-build-scan, sca-dependency-check]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: .

      - name: Load Docker Image
        run: docker load < image.tar

      # -----------------------------------------------------------------------
      # DOCKER HUB LOGIN
      # -----------------------------------------------------------------------
      # WHY: Authenticates with Docker Hub for image push
      # SECURITY: Credentials stored in GitHub Secrets
      # -----------------------------------------------------------------------
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # -----------------------------------------------------------------------
      # TAG AND PUSH IMAGE
      # -----------------------------------------------------------------------
      # WHY: Publishes image with multiple tags for versioning
      # TAGS: SHA for traceability, latest for convenience
      # -----------------------------------------------------------------------
      - name: Tag and Push Docker Image
        run: |
          # Tag with Docker Hub repository name
          docker tag ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }} \
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          docker tag ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }} \
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest
          
          # Push all tags
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest
          
          echo "âœ… Image pushed successfully!"
          echo "Image: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}"

  # ===========================================================================
  # PIPELINE SUMMARY
  # ===========================================================================
  
  pipeline-summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [build-and-test, sast-codeql, sca-dependency-check, docker-build-scan]
    if: always()
    
    steps:
      - name: Generate Pipeline Summary
        run: |
          echo "## ðŸ“Š CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Test | ${{ needs.build-and-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SAST (CodeQL) | ${{ needs.sast-codeql.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SCA (Dependency Check) | ${{ needs.sca-dependency-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build & Scan | ${{ needs.docker-build-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

